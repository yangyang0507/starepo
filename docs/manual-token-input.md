# æ‰‹åŠ¨ Token è¾“å…¥åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº† Starepo åº”ç”¨ä¸­æ‰‹åŠ¨è¾“å…¥ GitHub Personal Access Token çš„åŠŸèƒ½è®¾è®¡ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªå®‰å…¨ã€ä¾¿æ·çš„ Token ç®¡ç†æ–¹æ¡ˆã€‚

## åŠŸèƒ½éœ€æ±‚

### æ ¸å¿ƒåŠŸèƒ½

1. **Token è¾“å…¥ç•Œé¢** - æä¾›å®‰å…¨çš„ Token è¾“å…¥è¡¨å•
2. **Token éªŒè¯** - å®æ—¶éªŒè¯ Token çš„æœ‰æ•ˆæ€§å’Œæƒé™
3. **å®‰å…¨å­˜å‚¨** - åŠ å¯†å­˜å‚¨ç”¨æˆ·è¾“å…¥çš„ Token
4. **æƒé™æ£€æŸ¥** - éªŒè¯ Token æ˜¯å¦å…·å¤‡å¿…è¦çš„æƒé™
5. **Token ç®¡ç†** - æ”¯æŒæ›´æ–°ã€åˆ é™¤å’Œé‡æ–°éªŒè¯ Token

### ç”¨æˆ·ä½“éªŒè¦æ±‚

- æ¸…æ™°çš„æ“ä½œæŒ‡å¼•
- å®æ—¶çš„éªŒè¯åé¦ˆ
- å®‰å…¨æ€§æç¤ºå’Œæœ€ä½³å®è·µå»ºè®®
- é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶

## ç•Œé¢è®¾è®¡

### ä¸»ç•Œé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Starepo                       â”‚
â”‚         GitHub Token è®¾ç½®                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  ğŸ“ è¾“å…¥æ‚¨çš„ GitHub Personal Access Token   â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Token: [ghp_xxxxxxxxxxxxxxxxxxxx]  â”‚   â”‚
â”‚  â”‚         [ğŸ‘ï¸ æ˜¾ç¤º/éšè—]              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚  âœ… æƒé™æ£€æŸ¥ï¼š                              â”‚
â”‚  â€¢ read:user âœ“                             â”‚
â”‚  â€¢ user:email âœ“                            â”‚
â”‚  â€¢ public_repo âœ“                           â”‚
â”‚  â€¢ repo (å¯é€‰) âš ï¸                          â”‚
â”‚                                             â”‚
â”‚  ğŸ’¡ å¦‚ä½•åˆ›å»º Tokenï¼Ÿ                        â”‚
â”‚  [æŸ¥çœ‹è¯¦ç»†æŒ‡å—]                             â”‚
â”‚                                             â”‚
â”‚  [éªŒè¯å¹¶ä¿å­˜]  [å–æ¶ˆ]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Token åˆ›å»ºæŒ‡å—ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          GitHub Token åˆ›å»ºæŒ‡å—               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  ğŸ“‹ åˆ›å»ºæ­¥éª¤ï¼š                              â”‚
â”‚                                             â”‚
â”‚  1ï¸âƒ£ è®¿é—® GitHub Settings                   â”‚
â”‚     [æ‰“å¼€ GitHub Token è®¾ç½®é¡µé¢]            â”‚
â”‚                                             â”‚
â”‚  2ï¸âƒ£ ç‚¹å‡» "Generate new token (classic)"    â”‚
â”‚                                             â”‚
â”‚  3ï¸âƒ£ è®¾ç½® Token ä¿¡æ¯ï¼š                      â”‚
â”‚     â€¢ Note: Starepo App                   â”‚
â”‚     â€¢ Expiration: å»ºè®®é€‰æ‹© 90 days         â”‚
â”‚                                             â”‚
â”‚  4ï¸âƒ£ é€‰æ‹©æƒé™èŒƒå›´ï¼š                         â”‚
â”‚     âœ… read:user                           â”‚
â”‚     âœ… user:email                          â”‚
â”‚     âœ… public_repo                         â”‚
â”‚     âšª repo (è®¿é—®ç§æœ‰ä»“åº“ï¼Œå¯é€‰)             â”‚
â”‚                                             â”‚
â”‚  5ï¸âƒ£ ç‚¹å‡» "Generate token"                  â”‚
â”‚                                             â”‚
â”‚  6ï¸âƒ£ å¤åˆ¶ç”Ÿæˆçš„ Token                       â”‚
â”‚     âš ï¸ Token åªæ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·ç«‹å³å¤åˆ¶         â”‚
â”‚                                             â”‚
â”‚  [è¿”å›è¾“å…¥é¡µé¢]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€æœ¯å®ç°

### 1. Token è¾“å…¥ç»„ä»¶

```typescript
// src/renderer/components/auth/TokenInput.tsx
import React, { useState, useEffect } from 'react';
import { Input, Button, Alert, Progress, Card } from '@/components/ui';
import { Eye, EyeOff, CheckCircle, XCircle, AlertTriangle } from 'lucide-react';

interface TokenInputProps {
  onTokenValidated: (token: string, userInfo: GitHubUser) => void;
  onCancel: () => void;
}

interface GitHubUser {
  login: string;
  name: string;
  email: string;
  avatar_url: string;
}

interface TokenValidation {
  isValid: boolean;
  user?: GitHubUser;
  scopes: string[];
  missingScopes: string[];
  error?: string;
}

export const TokenInput: React.FC<TokenInputProps> = ({
  onTokenValidated,
  onCancel
}) => {
  const [token, setToken] = useState('');
  const [showToken, setShowToken] = useState(false);
  const [isValidating, setIsValidating] = useState(false);
  const [validation, setValidation] = useState<TokenValidation | null>(null);
  const [showGuide, setShowGuide] = useState(false);

  // å®æ—¶éªŒè¯ Token
  useEffect(() => {
    if (token.length > 10) {
      const timeoutId = setTimeout(() => {
        validateToken(token);
      }, 500); // é˜²æŠ–

      return () => clearTimeout(timeoutId);
    } else {
      setValidation(null);
    }
  }, [token]);

  const validateToken = async (tokenValue: string) => {
    setIsValidating(true);

    try {
      const result = await window.electronAPI.validateGitHubToken(tokenValue);
      setValidation(result);
    } catch (error) {
      setValidation({
        isValid: false,
        scopes: [],
        missingScopes: [],
        error: error instanceof Error ? error.message : 'éªŒè¯å¤±è´¥'
      });
    } finally {
      setIsValidating(false);
    }
  };

  const handleSubmit = () => {
    if (validation?.isValid && validation.user) {
      onTokenValidated(token, validation.user);
    }
  };

  const requiredScopes = ['read:user', 'user:email', 'public_repo'];
  const optionalScopes = ['repo'];

  return (
    <div className="token-input-container max-w-md mx-auto">
      {showGuide ? (
        <TokenGuide onBack={() => setShowGuide(false)} />
      ) : (
        <Card className="p-6">
          <div className="space-y-4">
            <div className="text-center">
              <h2 className="text-xl font-semibold mb-2">è¾“å…¥ GitHub Token</h2>
              <p className="text-sm text-gray-600">
                è¯·è¾“å…¥æ‚¨çš„ GitHub Personal Access Token
              </p>
            </div>

            {/* Token è¾“å…¥æ¡† */}
            <div className="relative">
              <Input
                type={showToken ? 'text' : 'password'}
                placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                value={token}
                onChange={(e) => setToken(e.target.value)}
                className="pr-10"
              />
              <button
                type="button"
                className="absolute right-2 top-1/2 transform -translate-y-1/2"
                onClick={() => setShowToken(!showToken)}
              >
                {showToken ? <EyeOff size={16} /> : <Eye size={16} />}
              </button>
            </div>

            {/* éªŒè¯è¿›åº¦ */}
            {isValidating && (
              <div className="space-y-2">
                <div className="flex items-center space-x-2">
                  <Progress value={50} className="flex-1" />
                  <span className="text-sm text-gray-500">éªŒè¯ä¸­...</span>
                </div>
              </div>
            )}

            {/* éªŒè¯ç»“æœ */}
            {validation && (
              <div className="space-y-3">
                {validation.isValid ? (
                  <Alert className="border-green-200 bg-green-50">
                    <CheckCircle className="h-4 w-4 text-green-600" />
                    <div>
                      <p className="font-medium text-green-800">
                        Token éªŒè¯æˆåŠŸï¼
                      </p>
                      {validation.user && (
                        <p className="text-sm text-green-700">
                          æ¬¢è¿ï¼Œ{validation.user.name || validation.user.login}ï¼
                        </p>
                      )}
                    </div>
                  </Alert>
                ) : (
                  <Alert variant="destructive">
                    <XCircle className="h-4 w-4" />
                    <div>
                      <p className="font-medium">Token éªŒè¯å¤±è´¥</p>
                      <p className="text-sm">{validation.error}</p>
                    </div>
                  </Alert>
                )}

                {/* æƒé™æ£€æŸ¥ */}
                <div className="space-y-2">
                  <h4 className="text-sm font-medium">æƒé™æ£€æŸ¥ï¼š</h4>
                  <div className="space-y-1">
                    {requiredScopes.map(scope => {
                      const hasScope = validation.scopes.includes(scope);
                      return (
                        <div key={scope} className="flex items-center space-x-2 text-sm">
                          {hasScope ? (
                            <CheckCircle className="h-4 w-4 text-green-500" />
                          ) : (
                            <XCircle className="h-4 w-4 text-red-500" />
                          )}
                          <span className={hasScope ? 'text-green-700' : 'text-red-700'}>
                            {scope} {hasScope ? '' : '(å¿…éœ€)'}
                          </span>
                        </div>
                      );
                    })}

                    {optionalScopes.map(scope => {
                      const hasScope = validation.scopes.includes(scope);
                      return (
                        <div key={scope} className="flex items-center space-x-2 text-sm">
                          {hasScope ? (
                            <CheckCircle className="h-4 w-4 text-green-500" />
                          ) : (
                            <AlertTriangle className="h-4 w-4 text-yellow-500" />
                          )}
                          <span className={hasScope ? 'text-green-700' : 'text-yellow-700'}>
                            {scope} (å¯é€‰)
                          </span>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}

            {/* å¸®åŠ©é“¾æ¥ */}
            <div className="text-center">
              <button
                type="button"
                className="text-sm text-blue-600 hover:text-blue-800 underline"
                onClick={() => setShowGuide(true)}
              >
                ğŸ’¡ å¦‚ä½•åˆ›å»º GitHub Tokenï¼Ÿ
              </button>
            </div>

            {/* æ“ä½œæŒ‰é’® */}
            <div className="flex space-x-3">
              <Button
                onClick={handleSubmit}
                disabled={!validation?.isValid || validation.missingScopes.length > 0}
                className="flex-1"
              >
                éªŒè¯å¹¶ä¿å­˜
              </Button>
              <Button
                variant="outline"
                onClick={onCancel}
                className="flex-1"
              >
                å–æ¶ˆ
              </Button>
            </div>
          </div>
        </Card>
      )}
    </div>
  );
};
```

### 2. Token åˆ›å»ºæŒ‡å—ç»„ä»¶

```typescript
// src/renderer/components/auth/TokenGuide.tsx
import React from 'react';
import { Button, Card, Badge } from '@/components/ui';
import { ExternalLink, ArrowLeft, Copy } from 'lucide-react';

interface TokenGuideProps {
  onBack: () => void;
}

export const TokenGuide: React.FC<TokenGuideProps> = ({ onBack }) => {
  const openGitHubTokenPage = () => {
    window.electronAPI.openExternal('https://github.com/settings/tokens/new');
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
  };

  const steps = [
    {
      number: 1,
      title: 'è®¿é—® GitHub Settings',
      description: 'ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€ GitHub Token è®¾ç½®é¡µé¢',
      action: (
        <Button onClick={openGitHubTokenPage} className="w-full">
          <ExternalLink className="mr-2 h-4 w-4" />
          æ‰“å¼€ GitHub Token è®¾ç½®é¡µé¢
        </Button>
      )
    },
    {
      number: 2,
      title: 'åˆ›å»ºæ–° Token',
      description: 'ç‚¹å‡» "Generate new token (classic)" æŒ‰é’®'
    },
    {
      number: 3,
      title: 'è®¾ç½® Token ä¿¡æ¯',
      description: 'å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š',
      details: [
        { label: 'Note', value: 'Starepo App', copyable: true },
        { label: 'Expiration', value: 'å»ºè®®é€‰æ‹© 90 days æˆ–æ›´é•¿' }
      ]
    },
    {
      number: 4,
      title: 'é€‰æ‹©æƒé™èŒƒå›´',
      description: 'è¯·å‹¾é€‰ä»¥ä¸‹æƒé™ï¼š',
      details: [
        { label: 'read:user', required: true, description: 'è¯»å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯' },
        { label: 'user:email', required: true, description: 'è·å–ç”¨æˆ·é‚®ç®±' },
        { label: 'public_repo', required: true, description: 'è®¿é—®å…¬å…±ä»“åº“' },
        { label: 'repo', required: false, description: 'è®¿é—®ç§æœ‰ä»“åº“ï¼ˆå¯é€‰ï¼‰' }
      ]
    },
    {
      number: 5,
      title: 'ç”Ÿæˆ Token',
      description: 'ç‚¹å‡»é¡µé¢åº•éƒ¨çš„ "Generate token" æŒ‰é’®'
    },
    {
      number: 6,
      title: 'å¤åˆ¶ Token',
      description: 'âš ï¸ Token åªä¼šæ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·ç«‹å³å¤åˆ¶å¹¶ä¿å­˜åˆ°å®‰å…¨çš„åœ°æ–¹',
      warning: true
    }
  ];

  return (
    <Card className="p-6 max-w-2xl mx-auto">
      <div className="space-y-6">
        {/* æ ‡é¢˜ */}
        <div className="flex items-center space-x-3">
          <Button variant="ghost" size="sm" onClick={onBack}>
            <ArrowLeft className="h-4 w-4" />
          </Button>
          <h2 className="text-xl font-semibold">GitHub Token åˆ›å»ºæŒ‡å—</h2>
        </div>

        {/* æ­¥éª¤åˆ—è¡¨ */}
        <div className="space-y-4">
          {steps.map((step) => (
            <div key={step.number} className="flex space-x-4">
              {/* æ­¥éª¤ç¼–å· */}
              <div className="flex-shrink-0">
                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
                  step.warning ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'
                }`}>
                  {step.number}
                </div>
              </div>

              {/* æ­¥éª¤å†…å®¹ */}
              <div className="flex-1 space-y-2">
                <h3 className="font-medium">{step.title}</h3>
                <p className="text-sm text-gray-600">{step.description}</p>

                {/* è¯¦ç»†ä¿¡æ¯ */}
                {step.details && (
                  <div className="space-y-2">
                    {step.details.map((detail, index) => (
                      <div key={index} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <div className="flex items-center space-x-2">
                          <span className="text-sm font-medium">{detail.label}:</span>
                          <span className="text-sm">{detail.value}</span>
                          {'required' in detail && (
                            <Badge variant={detail.required ? 'destructive' : 'secondary'}>
                              {detail.required ? 'å¿…éœ€' : 'å¯é€‰'}
                            </Badge>
                          )}
                        </div>
                        {'copyable' in detail && detail.copyable && (
                          <Button
                            size="sm"
                            variant="ghost"
                            onClick={() => copyToClipboard(detail.value)}
                          >
                            <Copy className="h-3 w-3" />
                          </Button>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {/* æƒé™è¯¦æƒ… */}
                {step.number === 4 && step.details && (
                  <div className="space-y-1">
                    {step.details.map((scope, index) => (
                      <div key={index} className="text-xs text-gray-500 ml-4">
                        â€¢ {scope.description}
                      </div>
                    ))}
                  </div>
                )}

                {/* æ“ä½œæŒ‰é’® */}
                {step.action && (
                  <div className="pt-2">
                    {step.action}
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>

        {/* å®‰å…¨æç¤º */}
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h4 className="font-medium text-yellow-800 mb-2">ğŸ”’ å®‰å…¨æç¤º</h4>
          <ul className="text-sm text-yellow-700 space-y-1">
            <li>â€¢ Token å…·æœ‰ä¸æ‚¨çš„ GitHub è´¦æˆ·ç›¸åŒçš„æƒé™ï¼Œè¯·å¦¥å–„ä¿ç®¡</li>
            <li>â€¢ ä¸è¦åœ¨å…¬å…±åœºæ‰€æˆ–ä¸å®‰å…¨çš„ç½‘ç»œç¯å¢ƒä¸‹è¾“å…¥ Token</li>
            <li>â€¢ å¦‚æœæ€€ç–‘ Token æ³„éœ²ï¼Œè¯·ç«‹å³åœ¨ GitHub è®¾ç½®ä¸­æ’¤é”€</li>
            <li>â€¢ Starepo ä¼šå°† Token åŠ å¯†å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨</li>
          </ul>
        </div>

        {/* è¿”å›æŒ‰é’® */}
        <div className="text-center">
          <Button onClick={onBack} className="w-full">
            è¿”å› Token è¾“å…¥é¡µé¢
          </Button>
        </div>
      </div>
    </Card>
  );
};
```

### 3. Token éªŒè¯æœåŠ¡

```typescript
// src/main/services/token-validator.ts
import { Octokit } from "@octokit/rest";

export interface TokenValidationResult {
  isValid: boolean;
  user?: {
    login: string;
    name: string;
    email: string;
    avatar_url: string;
  };
  scopes: string[];
  missingScopes: string[];
  error?: string;
}

export class GitHubTokenValidator {
  private static readonly REQUIRED_SCOPES = [
    "read:user",
    "user:email",
    "public_repo",
  ];
  private static readonly OPTIONAL_SCOPES = ["repo"];

  static async validateToken(token: string): Promise<TokenValidationResult> {
    try {
      // åˆ›å»º Octokit å®ä¾‹
      const octokit = new Octokit({
        auth: token,
        userAgent: "Starepo/1.0.0",
      });

      // éªŒè¯ Token å¹¶è·å–ç”¨æˆ·ä¿¡æ¯
      const [userResponse, emailResponse] = await Promise.all([
        octokit.rest.users.getAuthenticated(),
        octokit.rest.users
          .listEmailsForAuthenticatedUser()
          .catch(() => ({ data: [] })),
      ]);

      const user = userResponse.data;
      const emails = emailResponse.data;
      const primaryEmail =
        emails.find((email) => email.primary)?.email || user.email;

      // è·å– Token æƒé™èŒƒå›´
      const scopes = this.extractScopesFromHeaders(userResponse.headers);

      // æ£€æŸ¥å¿…éœ€æƒé™
      const missingScopes = this.REQUIRED_SCOPES.filter(
        (scope) => !scopes.includes(scope),
      );

      return {
        isValid: missingScopes.length === 0,
        user: {
          login: user.login,
          name: user.name || user.login,
          email: primaryEmail || "",
          avatar_url: user.avatar_url,
        },
        scopes,
        missingScopes,
      };
    } catch (error) {
      console.error("Token éªŒè¯å¤±è´¥:", error);

      let errorMessage = "Token éªŒè¯å¤±è´¥";

      if (error instanceof Error) {
        if (error.message.includes("401")) {
          errorMessage = "Token æ— æ•ˆæˆ–å·²è¿‡æœŸ";
        } else if (error.message.includes("403")) {
          errorMessage = "Token æƒé™ä¸è¶³";
        } else if (error.message.includes("404")) {
          errorMessage = "GitHub API è®¿é—®å¤±è´¥";
        } else {
          errorMessage = error.message;
        }
      }

      return {
        isValid: false,
        scopes: [],
        missingScopes: this.REQUIRED_SCOPES,
        error: errorMessage,
      };
    }
  }

  private static extractScopesFromHeaders(headers: any): string[] {
    const scopeHeader = headers["x-oauth-scopes"];
    if (!scopeHeader) return [];

    return scopeHeader
      .split(",")
      .map((scope: string) => scope.trim())
      .filter((scope: string) => scope.length > 0);
  }

  // æ£€æŸ¥ Token æ˜¯å¦å…·å¤‡ç‰¹å®šæƒé™
  static async checkTokenPermissions(
    token: string,
    requiredScopes: string[],
  ): Promise<boolean> {
    const result = await this.validateToken(token);
    return (
      result.isValid &&
      requiredScopes.every((scope) => result.scopes.includes(scope))
    );
  }

  // è·å– Token çš„è¯¦ç»†ä¿¡æ¯
  static async getTokenInfo(token: string): Promise<any> {
    try {
      const octokit = new Octokit({ auth: token });

      // è·å– Token çš„åº”ç”¨ä¿¡æ¯
      const response = await octokit.request("GET /applications/grants", {
        headers: {
          "X-GitHub-Api-Version": "2022-11-28",
        },
      });

      return response.data;
    } catch (error) {
      console.error("è·å– Token ä¿¡æ¯å¤±è´¥:", error);
      return null;
    }
  }
}
```

### 4. å®‰å…¨å­˜å‚¨å®ç°

```typescript
// src/main/services/secure-token-storage.ts
import { safeStorage, app } from "electron";
import * as path from "path";
import * as fs from "fs/promises";
import * as crypto from "crypto";

export class SecureTokenStorage {
  private static readonly TOKEN_FILE = "github-token.enc";
  private static readonly BACKUP_ENCRYPTION_KEY = "starepo-github-token-key";

  // è·å–å­˜å‚¨è·¯å¾„
  private static getStoragePath(): string {
    return path.join(app.getPath("userData"), this.TOKEN_FILE);
  }

  // å­˜å‚¨ Token
  static async storeToken(token: string, userInfo: any): Promise<void> {
    try {
      const tokenData = {
        token,
        userInfo,
        createdAt: Date.now(),
        lastValidated: Date.now(),
      };

      const jsonData = JSON.stringify(tokenData);
      let encryptedData: Buffer;

      // ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿå®‰å…¨å­˜å‚¨
      if (safeStorage.isEncryptionAvailable()) {
        encryptedData = safeStorage.encryptString(jsonData);
      } else {
        // é™çº§åˆ°è‡ªå®šä¹‰åŠ å¯†
        encryptedData = this.fallbackEncrypt(jsonData);
      }

      // å†™å…¥æ–‡ä»¶
      await fs.writeFile(this.getStoragePath(), encryptedData);

      console.log("Token å·²å®‰å…¨å­˜å‚¨");
    } catch (error) {
      console.error("Token å­˜å‚¨å¤±è´¥:", error);
      throw new Error("Token å­˜å‚¨å¤±è´¥");
    }
  }

  // è¯»å– Token
  static async retrieveToken(): Promise<{
    token: string;
    userInfo: any;
  } | null> {
    try {
      const storagePath = this.getStoragePath();

      // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      try {
        await fs.access(storagePath);
      } catch {
        return null; // æ–‡ä»¶ä¸å­˜åœ¨
      }

      // è¯»å–åŠ å¯†æ•°æ®
      const encryptedData = await fs.readFile(storagePath);
      let jsonData: string;

      // è§£å¯†æ•°æ®
      if (safeStorage.isEncryptionAvailable()) {
        jsonData = safeStorage.decryptString(encryptedData);
      } else {
        jsonData = this.fallbackDecrypt(encryptedData);
      }

      // è§£ææ•°æ®
      const tokenData = JSON.parse(jsonData);

      return {
        token: tokenData.token,
        userInfo: tokenData.userInfo,
      };
    } catch (error) {
      console.error("Token è¯»å–å¤±è´¥:", error);
      return null;
    }
  }

  // åˆ é™¤ Token
  static async clearToken(): Promise<void> {
    try {
      const storagePath = this.getStoragePath();
      await fs.unlink(storagePath);
      console.log("Token å·²åˆ é™¤");
    } catch (error) {
      // æ–‡ä»¶ä¸å­˜åœ¨æ—¶å¿½ç•¥é”™è¯¯
      if (error.code !== "ENOENT") {
        console.error("Token åˆ é™¤å¤±è´¥:", error);
      }
    }
  }

  // æ›´æ–°æœ€åéªŒè¯æ—¶é—´
  static async updateLastValidated(): Promise<void> {
    const tokenData = await this.retrieveToken();
    if (tokenData) {
      await this.storeToken(tokenData.token, {
        ...tokenData.userInfo,
        lastValidated: Date.now(),
      });
    }
  }

  // é™çº§åŠ å¯†ï¼ˆå½“ç³»ç»Ÿå®‰å…¨å­˜å‚¨ä¸å¯ç”¨æ—¶ï¼‰
  private static fallbackEncrypt(data: string): Buffer {
    const key = crypto.scryptSync(this.BACKUP_ENCRYPTION_KEY, "salt", 32);
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher("aes-256-cbc", key);

    let encrypted = cipher.update(data, "utf8", "hex");
    encrypted += cipher.final("hex");

    // å°† IV å’ŒåŠ å¯†æ•°æ®ç»„åˆ
    return Buffer.concat([iv, Buffer.from(encrypted, "hex")]);
  }

  // é™çº§è§£å¯†
  private static fallbackDecrypt(encryptedData: Buffer): string {
    const key = crypto.scryptSync(this.BACKUP_ENCRYPTION_KEY, "salt", 32);
    const iv = encryptedData.slice(0, 16);
    const encrypted = encryptedData.slice(16).toString("hex");

    const decipher = crypto.createDecipher("aes-256-cbc", key);
    let decrypted = decipher.update(encrypted, "hex", "utf8");
    decrypted += decipher.final("utf8");

    return decrypted;
  }

  // æ£€æŸ¥ Token æ˜¯å¦å­˜åœ¨
  static async hasToken(): Promise<boolean> {
    try {
      await fs.access(this.getStoragePath());
      return true;
    } catch {
      return false;
    }
  }
}
```

### 5. IPC é€šä¿¡æ¥å£

```typescript
// src/main/ipc/token.ts
import { ipcMain } from "electron";
import { GitHubTokenValidator } from "../services/token-validator";
import { SecureTokenStorage } from "../services/secure-token-storage";

export const setupTokenIPC = () => {
  // éªŒè¯ Token
  ipcMain.handle("validate-github-token", async (_, token: string) => {
    return await GitHubTokenValidator.validateToken(token);
  });

  // å­˜å‚¨ Token
  ipcMain.handle(
    "store-github-token",
    async (_, token: string, userInfo: any) => {
      await SecureTokenStorage.storeToken(token, userInfo);
      return true;
    },
  );

  // è¯»å– Token
  ipcMain.handle("retrieve-github-token", async () => {
    return await SecureTokenStorage.retrieveToken();
  });

  // åˆ é™¤ Token
  ipcMain.handle("clear-github-token", async () => {
    await SecureTokenStorage.clearToken();
    return true;
  });

  // æ£€æŸ¥ Token æ˜¯å¦å­˜åœ¨
  ipcMain.handle("has-github-token", async () => {
    return await SecureTokenStorage.hasToken();
  });
};
```

### 6. Preload è„šæœ¬æ‰©å±•

```typescript
// src/preload/preload.ts (æ‰©å±•)
contextBridge.exposeInMainWorld("electronAPI", {
  // ... å…¶ä»– API

  // Token ç›¸å…³ API
  validateGitHubToken: (token: string) =>
    ipcRenderer.invoke("validate-github-token", token),

  storeGitHubToken: (token: string, userInfo: any) =>
    ipcRenderer.invoke("store-github-token", token, userInfo),

  retrieveGitHubToken: () => ipcRenderer.invoke("retrieve-github-token"),

  clearGitHubToken: () => ipcRenderer.invoke("clear-github-token"),

  hasGitHubToken: () => ipcRenderer.invoke("has-github-token"),
});
```

## å®‰å…¨è€ƒè™‘

### 1. Token å®‰å…¨å­˜å‚¨

- ä¼˜å…ˆä½¿ç”¨ Electron çš„ `safeStorage` API
- é™çº§åˆ°è‡ªå®šä¹‰ AES åŠ å¯†
- å­˜å‚¨åœ¨ç”¨æˆ·æ•°æ®ç›®å½•ï¼Œé¿å…ç‰ˆæœ¬æ§åˆ¶

### 2. è¾“å…¥éªŒè¯

- å®æ—¶éªŒè¯ Token æ ¼å¼
- æ£€æŸ¥å¿…éœ€æƒé™èŒƒå›´
- é˜²æ­¢æ— æ•ˆ Token å­˜å‚¨

### 3. é”™è¯¯å¤„ç†

- ä¸åœ¨é”™è¯¯ä¿¡æ¯ä¸­æš´éœ²æ•æ„Ÿä¿¡æ¯
- æä¾›æ¸…æ™°çš„ç”¨æˆ·æŒ‡å¯¼
- è®°å½•è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

### 4. ç”¨æˆ·éšç§

- æœ¬åœ°å­˜å‚¨ï¼Œä¸ä¸Šä¼ åˆ°æœåŠ¡å™¨
- æä¾›æ¸…é™¤åŠŸèƒ½
- æ˜ç¡®å‘ŠçŸ¥æ•°æ®ç”¨é€”

## ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 1. å®æ—¶åé¦ˆ

- è¾“å…¥æ—¶å®æ—¶éªŒè¯
- æƒé™æ£€æŸ¥å¯è§†åŒ–
- åŠ è½½çŠ¶æ€æŒ‡ç¤º

### 2. é”™è¯¯æ¢å¤

- è¯¦ç»†çš„é”™è¯¯è¯´æ˜
- æä¾›è§£å†³æ–¹æ¡ˆ
- ä¸€é”®é‡è¯•åŠŸèƒ½

### 3. å¸®åŠ©æŒ‡å¯¼

- å†…ç½®åˆ›å»ºæŒ‡å—
- å¤–éƒ¨é“¾æ¥åˆ° GitHub
- æƒé™è¯´æ˜å’Œç”¨é€”

## æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

- Token éªŒè¯é€»è¾‘
- åŠ å¯†è§£å¯†åŠŸèƒ½
- æƒé™æ£€æŸ¥ç®—æ³•

### 2. é›†æˆæµ‹è¯•

- å®Œæ•´è¾“å…¥æµç¨‹
- å­˜å‚¨å’Œè¯»å–
- é”™è¯¯åœºæ™¯å¤„ç†

### 3. å®‰å…¨æµ‹è¯•

- åŠ å¯†å¼ºåº¦éªŒè¯
- æƒé™è¾¹ç•Œæµ‹è¯•
- æ•°æ®æ³„éœ²æ£€æŸ¥

## ä¸‹ä¸€æ­¥

1. é›†æˆ Octokit.js å®¢æˆ·ç«¯æ¶æ„
2. å®ç°ç»Ÿä¸€çš„è®¤è¯ç®¡ç†
3. æ·»åŠ  Token ç”Ÿå‘½å‘¨æœŸç®¡ç†
4. å®Œå–„é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒ
